# AlleyOop ‑ Cursor Debug / Code-Health Report

_Last updated: {{DATE}}_

---

## 1. High-level Architecture

* **Next.js 15 App-Router** – React 19 with RSC + client components.
* **TRPC** – `/src/server/api` provides routers exposed through `/app/api/trpc/[trpc]/route.ts`.
* **Prisma + Postgres** – Data layer in `/src/server/db.ts`.
* **Queue / Workers** – BullMQ processors in `/src/server/queue`.
* **RAG Pipeline** – Vector embeddings + retrieval in `/src/server/services/rag/**`.
* **Socket-IO** – Real-time events via `/src/server/websocket` (server) + `use-socket.ts` (client).

---

## 2. Critical Runtime Failures & Fixes Applied

| Area | Symptom | Root Cause | Fix Implemented |
|------|---------|-----------|-----------------|
| **Server/Client boundary** | “React Context unavailable in Server Components” | `SessionProvider` rendered in `layout.tsx` (RSC) | Moved all client-only providers into `app/_components/providers.tsx` |
| **Auth helpers** | `getServerAuthSession is not a function` | Wrong export from v5 wrapper | Re-implemented `auth-compat.ts` using `getServerSession` (v4) |
| **Socket-IO timeout** | Client couldn’t connect | API route placed in `/src/pages` (ignored by AppDir) | Added `/pages/api/socketio.ts`, updated hook path |
| **Dynamic imports** | “Element type is invalid…Promise” | Returned raw Promise instead of React component | Converted to `next/dynamic` in `knowledge/page.tsx` |
| **File I/O at build time** | ENOENT `./test/data/05-versions-space.pdf` | `pdf-parse` sample code executed during bundle | Switched to dynamic `import("pdf-parse")` |
| **Missing WASM** | `tiktoken_bg.wasm` error | Static import of `tiktoken` in RAG embeddings | Lazy-loaded tokenizer and added graceful fallback |
| **Zod validation** | “title required” on `document.create` | Title left blank → empty string invalid | Added default “Untitled Document” |
| **Nested form values** | “Expected object, received string” | `FormGenerator` had no ZodObject recursion | Implemented nested-object rendering |

---

## 3. Remaining Pain Points

1. **WebSocket auth**
   * `getServerAuthSession({ req, res })` still references the **deprecated** wrapper.
   * Recommend switching middleware to [`auth()`](https://next-auth.js.org/v4/auth) pattern.

2. **Socket-IO in production**
   * Custom `server.js` bypasses Vercel/Edge. Consider Next-15’s built-in [custom server removal](https://nextjs.org/docs/pages/building-your-application/routing/custom-server#nextjs-14-and-up).

3. **Dynamic imports in App Router**
   * Only `next/dynamic` (client) or `React.lazy` (Suspense) should be used. Search for `import('…')` pattern.

4. **Environment variables in client bundles**
   * Any `env.*` reference inside `/src/components` or `hooks` will be inlined. Use server-only helpers.

5. **Storage abstraction**
   * `S3StorageProvider` is a stub – upload/download will silently no-op.
   * Define `UPLOAD_DIR` env + ensure `LocalStorageProvider` path exists.

6. **Validation gaps**
   * TRPC routers rely on `ctx.session.user.id` but some mutations are unguarded (e.g. `document.list`).

7. **CI Quality Gates**
   * Added `check:client` script but not wired into GitHub Actions.

---

## 4. Suggested Next Steps

1. **Write E2E Playwright tests** covering:
   * Auth flow
   * New-document wizard
   * RAG search & generation

2. **Migrate Socket-IO to Next.js 15 ‘App-Router websockets’** once stable.

3. **Add schema-driven Title field**
   * `baseDocumentSchema.title` should be visible in Step-2 form; update `businessPlanFieldConfig` etc.

4. **Prune dead code**
   * `/src/server/services/storage/index.ts` duplicated providers – extract each into its own file.

5. **Upgrade to `@langchain/core@latest`** and verify tree-shakable builds.

---

## 5. Checklist for Every PR

1. `npm run check` – lint + type-check + client-boundary scan.
2. `npm run build && npm start` – catch RSC/runtime mismatches.
3. Load `/documents/new`, complete wizard locally.
4. Verify WebSocket connection in browser dev-tools.
5. Deploy to staging, run smoke tests.

---

> Generated by Cursor-AI comprehensive code review. 